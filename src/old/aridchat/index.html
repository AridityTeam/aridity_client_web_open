<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AridChat - Aridity</title>

    <!-- using cdn scripts so us developers can properly view the website without deploying -->

    <!-- update the version number as needed -->
    <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-functions-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-messaging-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-storage-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-remote-config-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-performance-compat.js"></script>
    <!-- 
      initialize the SDK after all desired features are loaded, set useEmulator to false
      to avoid connecting the SDK to running emulators.
    -->
    <script defer src="../firebase.js?useEmulator=true"></script>
  </head>
  <body>
    <style>
      body {
    background-color: #f3f2f3;
    margin: 0;
    padding: 0;
}

header {
    text-align: center;
}

#messages{
    padding-bottom: 30%;
}

li {
    list-style-type: none;
    margin-bottom: 10px;
    background-color: #6929ca;
    padding: 5px;
    border-radius: 10px;
    color: white;
    width: 50%;
}

li span {
    font-style: italic;
    font-weight: bolder;
    color: #b5b0b9;
}

#chat {
    width: 80%;
    margin: auto;
}

#message-form {
    text-align: center;
    position: fixed;
    left: 0;
    bottom: 0;
    width: 100%;
    background-color: #b7b5b9;
}

input {
    width: 70%;
    height: 30px;
}

button {
    width: 25%;
    height: 38px;
}

.sent {
    text-align: right;
    background-color: #a79cb3;
    margin-left: 50%;
}

.sent span {
    margin-left: 5px;
    color: #6929ca;
}
    </style>

    <script>
      function redirectTo(url) {
        window.location.href = url;
      }
    </script> 

    <div id="loggedInHome">

            <div id="chat">
              <!-- messages will display here -->
              <ul id="messages"></ul>
        
              <!-- form to send message -->
                <input id="message-input" type="text" />
                <button onclick="sendMessage();">Send</button>
            </div>
    </div>

    
    <p id="load">Firebase SDK Loading&hellip;</p>

    <script>
      var currentUser;

      document.addEventListener('DOMContentLoaded', function() {
        const loadEl = document.querySelector('#load');
        const loggedInMainEl = document.querySelector('#loggedInHome');

        firebase.auth()
          .getRedirectResult()
          .then((result) => {
            if (result.credential) {
              /** @type {firebase.auth.OAuthCredential} */
              var credential = result.credential;

              // This gives you a GitHub Access Token. You can use it to access the GitHub API.
              var token = credential.accessToken;
              // ...
          }

          // The signed-in user info.
          currentUser = result.user;
          // IdP data available in result.additionalUserInfo.profile.

          if(currentUser) {
            window.location.href = "index.html";
          }
        }).catch((error) => {
          // Handle Errors here.
          var errorCode = error.code;
          var errorMessage = error.message;
          // The email of the user's account used.
          var email = error.email;
          // The firebase.auth.AuthCredential type that was used.
          var credential = error.credential;
          // ...
        });

        firebase.auth().onAuthStateChanged((user) => {
          if (user) {
            // User is signed in, see docs for a list of available properties
            // https://firebase.google.com/docs/reference/js/v8/firebase.User
            var uid = user.uid;
            currentUser = firebase.auth().currentUser;
          } else {
            window.location.href = "../";
          }
        });

        const fetchChat = firebase.database().ref("messages/");
        fetchChat.on("child_added", function (snapshot) {
          const messages = snapshot.val();
          const message = `<li class=${
            username === messages.username ? "sent" : "receive"
            }><span>${messages.username}: </span>${messages.message}</li>
            `;
          // append the message on the page
          document.getElementById("messages").innerHTML += message;
        });

        try {
          let app = firebase.app();
          let features = [
            'auth', 
            'database', 
            'firestore',
            'functions',
            'messaging', 
            'storage', 
            'analytics', 
            'remoteConfig',
            'performance',
          ].filter(feature => typeof app[feature] === 'function');
          console.log(`Firebase SDK loaded with ${features.join(', ')}`);
          loadEl.textContent = ``;

        } catch (e) {
          console.error(e);
          loadEl.textContent = 'Error loading the Firebase SDK, screenshot the developer console and report it to the devs!';
        }
      });

      function showSettingsDropDown(visibility) {
        const settingsDropDownEl = document.querySelector('#settingsDropDown');

        if(visibility == true) {
            settingsDropDownEl.style.display = 'block';
        }
        else {
            settingsDropDownEl.style.display = 'none';
        }
      }

      async function sendMessage() {
        // get values to be submitted
        const timestamp = Date.now();
        const messageInput = document.getElementById("message-input");
        const message = messageInput.value;

        //auto scroll to bottom
        document
           .getElementById("messages")
           .scrollIntoView({ behavior: "smooth", block: "end", inline: "nearest" });

        // create db collection and send in the data
        await firebase.database().ref("messages/" + timestamp).set({
          username: firebase.auth().currentUser.displayName,
          message,
        });

        // clear the input box
        messageInput.value = "";
      }
    </script>
  </body>
</html>
